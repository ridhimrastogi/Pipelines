- job:
    name: iTrust
    project-type: pipeline
    dsl: |
        pipeline {
            agent any           

            stages {
                stage('cloning repo ... ') {
                    steps {
                        sh 'sudo rm -rf /var/lib/jenkins/workspace/iTrust/iTrust2-v6'
                        git branch: 'master', credentialsId: 'GIT_CRED', url: 'https://github.ncsu.edu/engr-csc326-staff/iTrust2-v6.git'
                        sh 'sudo cp /var/lib/jenkins_templates/db.properties.template /var/lib/jenkins/workspace/iTrust/iTrust2/src/main/java/db.properties'
                        sh 'sudo chmod 777 /var/lib/jenkins/workspace/iTrust/iTrust2/src/main/java/db.properties'

                        sh 'function subst() { eval echo -E "$2"; }'
                        sh 'mapfile -c 1 -C subst < /var/lib/jenkins_templates/email.properties.template | sudo tee /var/lib/jenkins/workspace/iTrust/iTrust2/src/main/java/email.properties'
                        sh 'sudo chmod 777 /var/lib/jenkins/workspace/iTrust/iTrust2/src/main/java/email.properties'
                    }
                }               
                stage('build'){
                    steps{                                            
                        sh 'cd /var/lib/jenkins/workspace/iTrust/iTrust2 && sudo mvn -f pom-data.xml process-test-classes'
                    }
                }
            }
            post{
                always{                   
                    sh 'cd /var/lib/jenkins/workspace/iTrust/iTrust2 && sudo mvn clean test verify org.apache.maven.plugins:maven-checkstyle-plugin:3.1.0:checkstyle'
                }
            }
        }