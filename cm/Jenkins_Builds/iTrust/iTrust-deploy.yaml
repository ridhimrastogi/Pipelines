- job:
    name: iTrust
    project-type: pipeline
    dsl: |
        pipeline {
            agent any           

            stages {
                stage('cloning repo ... ') {
                    steps {
                        sh 'sudo rm -rf /var/lib/jenkins/workspace/iTrust/iTrust2-v6'
                        git branch: 'master', credentialsId: 'GIT_CRED', url: 'https://github.ncsu.edu/engr-csc326-staff/iTrust2-v6.git'
                        sh 'sudo cp /var/lib/jenkins_templates/db.properties.template /var/lib/jenkins/workspace/iTrust/iTrust2/src/main/java/db.properties'
                        sh 'sudo chmod 777 /var/lib/jenkins/workspace/iTrust/iTrust2/src/main/java/db.properties'
                        sh 'cd /var/lib/jenkins_templates/ && envsubst < email.properties.template | sudo tee /var/lib/jenkins/workspace/iTrust/iTrust2/src/main/java/email.properties'
                        sh 'sudo chmod 777 /var/lib/jenkins/workspace/iTrust/iTrust2/src/main/java/email.properties'
                    }
                }
                stage('build'){
                    steps{
                        sh 'cd /var/lib/jenkins/workspace/iTrust/iTrust2 && sudo mvn -f pom-data.xml process-test-classes'
                    }
                }
                stage('deploy'){
                    steps{
                        sh 'cd /var/lib/jenkins/workspace/iTrust/iTrust2 && sudo mvn package'
                        sh 'sudo cp /var/lib/jenkins/workspace/iTrust/iTrust2/target/iTrust2.war /bakerx/cm/roles/deploy-itrust/files/iTrust2.war'
                        sh 'sudo mysqldump iTrust2 > /bakerx/cm/roles/deploy-itrust/files/iTrust2_backup.sql'
                    }
                }
            }
        }